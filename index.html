<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Escape the Maze</title>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Merriweather', serif;
      /* ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω—ã –ø—Ä–æ–±–µ–ª—ã –≤ URL */
      background-image: url('https://i.ibb.co/VpWTTmSB/Chat-GPT-Image-13-2025-23-06-57-1.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: #0d3a23;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      min-height: 100vh;
    }

    h1 {
      font-size: 1.8rem;
      margin: 10px 0 6px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .top-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .ui-panel {
      background: #aef5b5;
      border-radius: 8px;
      padding: 8px 12px;
      margin: 6px 0;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    #keys-display {
      display: flex;
      gap: 3px;
    }

    .key-icon {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.3;
    }
    .key-icon.collected {
      opacity: 1;
    }

    #key-0,
    #key-1,
    #key-2 {
      background-image: url('https://i.ibb.co/C3CcTYFP/food1-png.png');
    }

    #key-3,
    #key-4,
    #key-5 {
      background-image: url('https://i.ibb.co/nNWShMyS/food2-png.png');
    }

    #canvas-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      aspect-ratio: 1 / 1;
      margin: 8px 0;
    }

    canvas {
      background: #ffffff;
      border-radius: 6px;
      display: block;
      width: 100%;
      height: 100%;
    }

    .game-area {
      display: flex;
      gap: 12px;
      width: 100%;
      max-width: 600px;
      align-items: center;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .arrow-btn {
      width: 48px;
      height: 48px;
      padding: 0;
      margin: 0;
      background: transparent !important;
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      border-radius: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .arrow-btn:hover {
      background: #089ab8;
      transform: scale(1.05);
    }

    .arrow-btn:active {
      transform: scale(0.97);
    }

    #up { width: 48px; align-self: center; }
    #left, #right { width: 48px; }
    #down { width: 48px; align-self: center; }

    .btn {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    .btn:hover {
      background: #0da473;
      transform: translateY(-1px);
    }

    button,
    .arrow-btn,
    .btn {
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    button:focus,
    button:focus-visible,
    .arrow-btn:focus,
    .arrow-btn:focus-visible,
    .btn:focus,
    .btn:focus-visible {
      outline: none;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: #aef5b5;
      border-radius: 14px;
      padding: 24px;
      text-align: center;
      max-width: 90%;
      width: 360px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal h2 {
      font-size: 1.8rem;
      margin-bottom: 12px;
      color: #0d3a23;
    }

    .modal p {
      font-size: 1.1rem;
      margin: 8px 0;
    }

    @media (max-width: 500px) {
      .game-area {
        flex-direction: column;
        align-items: center;
      }
      .controls {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
      }
      .arrow-btn {
        width: 44px;
        height: 44px;
        font-size: 1.2rem;
      }
      #up, #down { width: 44px; }
    }
  </style>
</head>
<body>
  <h1>Escape the Maze</h1>

  <div class="top-bar">
    <button id="new-maze" class="btn">New Maze</button>
    <button id="replay" class="btn">Replay</button>
  </div>

  <div class="ui-panel">
    Keys: <span id="keys-collected">0</span>/6
    <div id="keys-display">
      <div class="key-icon" id="key-0"></div>
      <div class="key-icon" id="key-1"></div>
      <div class="key-icon" id="key-2"></div>
      <div class="key-icon" id="key-3"></div>
      <div class="key-icon" id="key-4"></div>
      <div class="key-icon" id="key-5"></div>
    </div>
  </div>

  <div class="game-area">
    <div id="canvas-container">
      <canvas id="mazeCanvas"></canvas>
    </div>
    <div class="controls">
      <button id="up" class="arrow-btn">
        <img src="https://i.ibb.co/zVJmCGN7/Chat-GPT-Image-20-2025-15-42-39.png"
             alt="up"
             style="width: 100%; height: 100%; object-fit: contain;">
      </button>
      <div style="display:flex; gap:10px; margin-top: 5px; margin-bottom: 5px;">
        <button id="left" class="arrow-btn">
          <img src="https://i.ibb.co/rGrwT8Vg/Chat-GPT-Image-20-2025-15-50-24.png"
               alt="left"
               style="width: 100%; height: 100%; object-fit: contain;">
        </button>
        <button id="right" class="arrow-btn">
          <img src="https://i.ibb.co/Q7HvmJZ9/Chat-GPT-Image-20-2025-15-45-58.png"
               alt="right"
               style="width: 100%; height: 100%; object-fit: contain;">
        </button>
      </div>
      <button id="down" class="arrow-btn">
        <img src="https://i.ibb.co/gMvNCdTk/Chat-GPT-Image-20-2025-15-44-21.png"
             alt="down"
             style="width: 100%; height: 100%; object-fit: contain;">
      </button>
    </div>
  </div>

  <!-- –ü–æ–±–µ–¥–∞ -->
  <div id="win-modal" class="modal">
    <div class="modal-content">
      <h2>üéâ You Escaped!</h2>
      <p><strong>‚≠ê Perfect route!</strong></p>
      <p>Total moves: <span id="final-moves">0</span></p>
      <button id="close-modal" class="btn" style="margin-top: 12px;">Play Again</button>
    </div>
  </div>

  <!-- –ö–í–ò–ó -->
  <div id="quiz-modal" class="modal">
    <div class="modal-content">
      <h2>üî§ Grammar Check!</h2>
      <p id="quiz-question" style="font-size: 1.2rem; margin: 16px 0; min-height: 2em;"></p>
      <div id="quiz-options" style="display: flex; flex-direction: column; gap: 8px; margin: 12px 0;"></div>
      <p id="quiz-feedback" style="color: #d32f2f; font-weight: bold; min-height: 1.4em;"></p>
    </div>
  </div>

  <script>
    const ROWS = 11;
    const COLS = 11;
    const WALL = 1;
    const PATH = 0;
    const PLAYER_COLOR = '#06b6d4';
    const GOAL_COLOR = '#10b981';
    const KEY_COLOR = '#fbbf24';

    const playerImg = new Image();
    playerImg.src = 'https://i.ibb.co/tp4n66N4/hero-png.png';

    const keyImg1 = new Image();
    keyImg1.src = 'https://i.ibb.co/nNWShMyS/food2-png.png';

    const keyImg2 = new Image();
    keyImg2.src = 'https://i.ibb.co/C3CcTYFP/food1-png.png';

    const goalImg = new Image();
    goalImg.src = 'https://i.ibb.co/3JCnKQ2/Chat-GPT-Image-20-2025-15-59-48.png';
	
	// ‚úÖ –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ª–∞–±–∏—Ä–∏–Ω—Ç, –∫–æ–≥–¥–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø—Ä–æ–≥—Ä—É–∑–∏–ª–∏—Å—å
let imagesToLoad = 4;
let imagesLoaded = 0;

[playerImg, keyImg1, keyImg2, goalImg].forEach(img => {
  img.onload = () => {
    imagesLoaded++;
    // –∫–æ–≥–¥–∞ –≤—Å–µ 4 –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –∏ –ª–∞–±–∏—Ä–∏–Ω—Ç —É–∂–µ —Å–æ–∑–¥–∞–Ω ‚Äî –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
    if (imagesLoaded === imagesToLoad && maze.length > 0 && ctx && canvas) {
      render();
    }
  };
});

   const quizQuestions = [
  ["She walks to school every day.","Present Continuous","Future Simple","Present Simple","Past Simple",3],

  ["He is reading a book.","Future Simple","Present Continuous","Past Simple","Present Simple",2],   // ‚úî now removed

  ["They played football yesterday.","Present Simple","Past Simple","Future Simple","Present Continuous",2],
  ["We will travel to London next year.","Past Simple","Present Continuous","Future Simple","Present Simple",3],
  ["I am cooking dinner at the moment.","Present Continuous","Past Simple","Future Simple","Present Simple",1],
  ["Tom watches TV every evening.","Future Simple","Present Simple","Present Continuous","Past Simple",2],
  ["She visited her grandma last week.","Present Continuous","Future Simple","Past Simple","Present Simple",3],
  ["They will start the game soon.","Present Continuous","Future Simple","Present Simple","Past Simple",2],
  ["I am writing a message right now.","Past Simple","Present Continuous","Future Simple","Present Simple",2],

  ["He works in a bank.","Present Simple","Future Simple","Present Continuous","Past Simple",1],
  ["We went to the museum yesterday.","Present Simple","Past Simple","Present Continuous","Future Simple",2],
  ["She will call you tomorrow.","Past Simple","Future Simple","Present Simple","Present Continuous",2],
  
  ["They are playing with the dog.","Past Simple","Future Simple","Present Continuous","Present Simple",3],  // ‚úî now removed

  ["He studies French at school.","Future Simple","Present Continuous","Present Simple","Past Simple",3],
  ["I bought new shoes last month.","Past Simple","Present Continuous","Present Simple","Future Simple",1],
  ["We will visit Paris in June.","Present Simple","Future Simple","Past Simple","Present Continuous",2],
  ["She is drawing a picture right now.","Future Simple","Present Continuous","Past Simple","Present Simple",2],
  ["They often go to the cinema.","Past Simple","Future Simple","Present Simple","Present Continuous",3],
  ["He cleaned his room yesterday.","Present Continuous","Present Simple","Past Simple","Future Simple",3],
  ["I will see you later.","Present Continuous","Future Simple","Past Simple","Present Simple",2],

  ["She is running in the park.","Present Simple","Present Continuous","Future Simple","Past Simple",2],     // ‚úî now removed

  ["They visited Spain last summer.","Future Simple","Past Simple","Present Simple","Present Continuous",2],
  ["He meets his friends every weekend.","Present Simple","Present Continuous","Past Simple","Future Simple",1],
  ["We are watching a movie at the moment.","Present Continuous","Future Simple","Present Simple","Past Simple",1],
  ["I will finish the project tomorrow.","Future Simple","Past Simple","Present Continuous","Present Simple",1],
  ["Tom cooked dinner yesterday.","Past Simple","Present Continuous","Present Simple","Future Simple",1],
  ["She will join us later.","Present Continuous","Future Simple","Past Simple","Present Simple",2],
  ["They are studying for the test now.","Future Simple","Past Simple","Present Continuous","Present Simple",3],
  ["He drives to work every morning.","Present Continuous","Present Simple","Future Simple","Past Simple",2],

  ["We watched a movie last night.","Past Simple","Present Continuous","Future Simple","Present Simple",1],

  ["The cat is sleeping.","Future Simple","Present Continuous","Present Simple","Past Simple",2],  // ‚úî now removed

  ["They will buy a new car.","Present Continuous","Past Simple","Future Simple","Present Simple",3],
  ["She reads books every weekend.","Future Simple","Present Simple","Present Continuous","Past Simple",2],
  ["I am learning English now.","Present Continuous","Future Simple","Past Simple","Present Simple",1],
  ["We traveled to Italy last year.","Present Simple","Past Simple","Future Simple","Present Continuous",2],
  ["He will clean his room later.","Future Simple","Present Simple","Past Simple","Present Continuous",1],
  ["They are having dinner right now.","Past Simple","Present Continuous","Present Simple","Future Simple",2],
  ["She wrote a letter yesterday.","Present Continuous","Future Simple","Past Simple","Present Simple",3],
  ["He will start a new job soon.","Present Simple","Past Simple","Future Simple","Present Continuous",3],
  ["We are playing chess now.","Present Simple","Present Continuous","Past Simple","Future Simple",2],
  
  ["I walk to work every morning.","Past Simple","Present Simple","Present Continuous","Future Simple",2],
  ["They cooked breakfast yesterday.","Future Simple","Present Continuous","Past Simple","Present Simple",3],
  ["She is washing the dishes now.","Future Simple","Present Continuous","Past Simple","Present Simple",2],
  ["We will fly to Spain next week.","Present Simple","Future Simple","Past Simple","Present Continuous",2],
  ["He plays tennis every Saturday.","Present Continuous","Past Simple","Present Simple","Future Simple",3],
  ["They were in the park yesterday.","Present Continuous","Future Simple","Past Simple","Present Simple",3],
  ["I am reading a book right now.","Present Continuous","Present Simple","Future Simple","Past Simple",1],
  ["She will bake a cake tomorrow.","Present Simple","Past Simple","Future Simple","Present Continuous",3]
];


    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
    let maze = [];
    let originalKeys = [];
    let originalGoal = null;
    let player = { x: 1, y: 1 };
    let keys = [];
    let goal = null;
    let collectedKeys = 0;
    let moves = 0;
    let ctx, canvas;
    let cellSize;

    // –î–ª—è –∫–≤–∏–∑–∞
    let questionUsageCount = new Map();
    let isQuizActive = false;
    let quizStage = 0; // 0 = –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω, 1 = –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å, 2 = –≤—Ç–æ—Ä–æ–π

    document.addEventListener('DOMContentLoaded', () => {
      canvas = document.getElementById('mazeCanvas');
      ctx = canvas.getContext('2d');
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      generateNewMaze();
      render();
// ‚úÖ –ö–æ–≥–¥–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ–¥–≥—Ä—É–∑—è—Ç—Å—è ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –ª–∞–±–∏—Ä–∏–Ω—Ç,
  // —á—Ç–æ–±—ã –≤–º–µ—Å—Ç–æ –∫—Ä—É–∂–∫–æ–≤ –ø–æ—è–≤–∏–ª–∏—Å—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ–¥—ã/–≥–µ—Ä–æ—è/–≤—ã—Ö–æ–¥–∞
  [playerImg, keyImg1, keyImg2, goalImg].forEach(img => {
    if (!img.complete || !img.naturalWidth) {
      img.onload = () => {
        if (maze.length > 0 && ctx && canvas) {
          render();
        }
      };
    }
  });
      document.getElementById('new-maze').addEventListener('click', generateNewMaze);
      document.getElementById('replay').addEventListener('click', replay);
      document.getElementById('close-modal').addEventListener('click', () => {
        document.getElementById('win-modal').style.display = 'none';
        replay();
      });

      // –°—Ç—Ä–µ–ª–∫–∏
      document.getElementById('up').addEventListener('click', () => movePlayer(0, -1));
      document.getElementById('down').addEventListener('click', () => movePlayer(0, 1));
      document.getElementById('left').addEventListener('click', () => movePlayer(-1, 0));
      document.getElementById('right').addEventListener('click', () => movePlayer(1, 0));

      // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
      document.addEventListener('keydown', (e) => {
        if (isQuizActive) return;
        switch (e.key) {
          case 'ArrowUp': movePlayer(0, -1); break;
          case 'ArrowDown': movePlayer(0, 1); break;
          case 'ArrowLeft': movePlayer(-1, 0); break;
          case 'ArrowRight': movePlayer(1, 0); break;
        }
      });
    });

    function resizeCanvas() {
      const container = document.getElementById('canvas-container');
      const size = Math.min(container.clientWidth, container.clientHeight);
      canvas.width = size;
      canvas.height = size;
      cellSize = size / COLS;
      if (maze.length > 0) render();
    }

    function generateNewMaze() {
      maze = Array(ROWS).fill().map(() => Array(COLS).fill(WALL));
      const stack = [{ x: 1, y: 1 }];
      maze[1][1] = PATH;

      const directions = [
        { dx: 0, dy: -2 },
        { dx: 2, dy: 0 },
        { dx: 0, dy: 2 },
        { dx: -2, dy: 0 }
      ];

      while (stack.length > 0) {
        const current = stack[stack.length - 1];
        const neighbors = [];

        for (const dir of directions) {
          const nx = current.x + dir.dx;
          const ny = current.y + dir.dy;
          if (nx > 0 && nx < COLS - 1 && ny > 0 && ny < ROWS - 1 && maze[ny][nx] === WALL) {
            neighbors.push({ x: nx, y: ny, dir });
          }
        }

        if (neighbors.length > 0) {
          const next = neighbors[Math.floor(Math.random() * neighbors.length)];
          const wallX = current.x + next.dir.dx / 2;
          const wallY = current.y + next.dir.dy / 2;
          maze[wallY][wallX] = PATH;
          maze[next.y][next.x] = PATH;
          stack.push(next);
        } else {
          stack.pop();
        }
      }

      const reachable = getReachableCells(maze, 1, 1);
      const candidates = reachable.filter(p => !(p.x === 1 && p.y === 1));

      originalKeys = [];
      for (let i = 0; i < 6 && candidates.length > 0; i++) {
        const idx = Math.floor(Math.random() * candidates.length);
        const pos = candidates.splice(idx, 1)[0];
        originalKeys.push({ x: pos.x, y: pos.y });
      }

      while (originalKeys.length < 6) {
        const idx = Math.floor(Math.random() * reachable.length);
        const pos = reachable[idx];
        if (pos.x !== 1 || pos.y !== 1) {
          originalKeys.push({ x: pos.x, y: pos.y });
        }
      }

      originalGoal = null;
      resetGameState();
      render();
    }

    function replay() {
      resetGameState();
      render();
    }

    function resetGameState() {
      player = { x: 1, y: 1 };
      moves = 0;
      keys = originalKeys.map(k => ({ x: k.x, y: k.y, collected: false }));
      collectedKeys = 0;
      goal = originalGoal ? { x: originalGoal.x, y: originalGoal.y } : null;
      updateKeysUI();
      questionUsageCount = new Map();
    }

    function getReachableCells(maze, sx, sy) {
      const visited = Array(ROWS).fill().map(() => Array(COLS).fill(false));
      const result = [];
      const queue = [{ x: sx, y: sy }];
      visited[sy][sx] = true;
      const dirs = [[0,1],[0,-1],[1,0],[-1,0]];

      while (queue.length) {
        const {x, y} = queue.shift();
        result.push({x, y});
        for (const [dx, dy] of dirs) {
          const nx = x + dx, ny = y + dy;
          if (nx >= 0 && nx < COLS && ny >= 0 && ny < ROWS && !visited[ny][nx] && maze[ny][nx] === PATH) {
            visited[ny][nx] = true;
            queue.push({x: nx, y: ny});
          }
        }
      }
      return result;
    }

    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          if (maze[y][x] === WALL) {
            ctx.fillStyle = '#6FD67F';
            ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
          }
        }
      }

      keys.forEach((key, index) => {
        if (!key.collected) {
          const size = cellSize * 1.5;
          const img = index < 3 ? keyImg1 : keyImg2;
          if (img.complete && img.naturalWidth) {
            ctx.drawImage(
              img,
              (key.x + 0.5) * cellSize - size / 2,
              (key.y + 0.5) * cellSize - size / 2,
              size,
              size
            );
          } else {
            ctx.fillStyle = KEY_COLOR;
            ctx.beginPath();
            ctx.arc(
              (key.x + 0.5) * cellSize,
              (key.y + 0.5) * cellSize,
              cellSize * 0.3,
              0,
              Math.PI * 2
            );
            ctx.fill();
          }
        }
      });

      if (goal) {
        if (goalImg.complete && goalImg.naturalWidth) {
          const size = cellSize * 1.8;
          ctx.drawImage(
            goalImg,
            (goal.x + 0.5) * cellSize - size / 2,
            (goal.y + 0.5) * cellSize - size / 2,
            size,
            size
          );
        } else {
          ctx.fillStyle = GOAL_COLOR;
          ctx.beginPath();
          ctx.arc(
            (goal.x + 0.5) * cellSize,
            (goal.y + 0.5) * cellSize,
            cellSize * 0.4,
            0,
            Math.PI * 2
          );
          ctx.fill();
        }
      }

      if (playerImg.complete && playerImg.naturalWidth) {
        const size = cellSize * 2.0;
        ctx.drawImage(
          playerImg,
          (player.x + 0.5) * cellSize - size / 2,
          (player.y + 0.5) * cellSize - size / 2,
          size,
          size
        );
      } else {
        ctx.fillStyle = PLAYER_COLOR;
        ctx.beginPath();
        ctx.arc(
          (player.x + 0.5) * cellSize,
          (player.y + 0.5) * cellSize,
          cellSize * 0.35,
          0,
          Math.PI * 2
        );
        ctx.fill();
      }
    }

    // ‚úÖ –û–°–ù–û–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ø—Ä–∏ —Å–±–æ—Ä–µ –∫–ª—é—á–∞ ‚Äî –¥–≤–∞ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–¥—Ä—è–¥
    function movePlayer(dx, dy) {
      if (isQuizActive) return;

      const newX = player.x + dx;
      const newY = player.y + dy;

      if (newX >= 0 && newX < COLS && newY >= 0 && newY < ROWS && maze[newY][newX] === PATH) {
        player.x = newX;
        player.y = newY;
        moves++;

        let keyCollectedNow = false;

        // –°–±–æ—Ä –∫–ª—é—á–µ–π
        for (const key of keys) {
          if (!key.collected && key.x === player.x && key.y === player.y) {
            key.collected = true;
            collectedKeys++;
            updateKeysUI();
            checkAllKeysCollected();
            keyCollectedNow = true;
            break;
          }
        }

        // –ü–æ–±–µ–¥–∞
        if (goal && collectedKeys === 6 && player.x === goal.x && player.y === goal.y) {
          showWinModal();
          return;
        }

        // –û–±—ã—á–Ω—ã–π –∫–≤–∏–∑ –∫–∞–∂–¥—ã–µ 10 —Ö–æ–¥–æ–≤ ‚Äî –ù–û —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–µ —Å–±–æ—Ä –∫–ª—é—á–∞
        if (!keyCollectedNow && moves > 0 && moves % 10 === 0) {
          showQuiz(1); // 1-–π –≤–æ–ø—Ä–æ—Å
        } 
        // –ï—Å–ª–∏ —Å–æ–±—Ä–∞–ª–∏ –∫–ª—é—á ‚Äî —Å—Ä–∞–∑—É 2 –≤–æ–ø—Ä–æ—Å–∞
        else if (keyCollectedNow) {
          triggerDoubleQuiz();
        } else {
          render();
        }
      }
    }

    // ‚úÖ –î–í–ê –í–û–ü–†–û–°–ê –ü–û–î–†–Ø–î –ü–†–ò –°–ë–û–†–ï –ö–õ–Æ–ß–ê
    function triggerDoubleQuiz() {
      quizStage = 1; // –ø–µ—Ä–≤—ã–π –∏–∑ –¥–≤—É—Ö
      showQuiz(1);
    }

    function showQuiz(stage) {
      const availableIndices = [];
      for (let i = 0; i < quizQuestions.length; i++) {
        const used = questionUsageCount.get(i) || 0;
        if (used < 2) {
          availableIndices.push(i);
        }
      }

      if (availableIndices.length === 0) {
        for (let i = 0; i < quizQuestions.length; i++) {
          availableIndices.push(i);
        }
      }

      const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
      const currentCount = questionUsageCount.get(randomIndex) || 0;
      questionUsageCount.set(randomIndex, currentCount + 1);

      const q = quizQuestions[randomIndex];
      const correctIdx = q[4] - 1;
      const answers = [q[1], q[2], q[3]];

      document.getElementById('quiz-question').textContent = q[0];
      const optionsContainer = document.getElementById('quiz-options');
      optionsContainer.innerHTML = '';
      document.getElementById('quiz-feedback').textContent = '';

      answers.forEach((ans, idx) => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = ans;
        btn.style.width = '100%';
        btn.style.padding = '10px';
        btn.onclick = () => {
          if (idx === correctIdx) {
            document.getElementById('quiz-feedback').textContent = '‚úÖ Correct!';
            document.getElementById('quiz-feedback').style.color = '#10b981';

            setTimeout(() => {
              if (quizStage === 1) {
                // –ü–æ—Å–ª–µ 1-–≥–æ ‚Äî —Å—Ä–∞–∑—É –≤—Ç–æ—Ä–æ–π
                quizStage = 2;
                showQuiz(2);
              } else {
                // –ü–æ—Å–ª–µ 2-–≥–æ ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ–º
                quizStage = 0;
                isQuizActive = false;
                document.getElementById('quiz-modal').style.display = 'none';
                render();
              }
            }, 600);
          } else {
            document.getElementById('quiz-feedback').textContent = '‚ùå No, try again!';
            document.getElementById('quiz-feedback').style.color = '#d32f2f';
          }
        };
        optionsContainer.appendChild(btn);
      });

      isQuizActive = true;
      document.getElementById('quiz-modal').style.display = 'flex';
    }

    function updateKeysUI() {
      document.getElementById('keys-collected').textContent = collectedKeys;
      keys.forEach((key, index) => {
        const el = document.getElementById(`key-${index}`);
        if (el) el.classList.toggle('collected', key.collected);
      });
    }

    function checkAllKeysCollected() {
      if (collectedKeys === 6 && !goal) {
        const reachable = getReachableCells(maze, 1, 1);
        const candidates = reachable.filter(p =>
          !(p.x === player.x && p.y === player.y) &&
          !keys.some(k => k.x === p.x && k.y === p.y)
        );

        if (candidates.length > 0) {
          const idx = Math.floor(Math.random() * candidates.length);
          goal = candidates[idx];
          originalGoal = { x: goal.x, y: goal.y };
        } else {
          goal = { x: COLS - 2, y: ROWS - 2 };
          originalGoal = { x: goal.x, y: goal.y };
        }
        render();
      }
    }

    function showWinModal() {
      document.getElementById('final-moves').textContent = moves;
      document.getElementById('win-modal').style.display = 'flex';
    }
  </script>
</body>
</html>